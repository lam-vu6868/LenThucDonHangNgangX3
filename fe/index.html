<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>ÄÄƒng nháº­p - Meal Planner</title>
    <link rel="stylesheet" href="css/style.css?v=1" />
    <link rel="stylesheet" href="css/components.css?v=1" />
  </head>
  <body class="auth-page">
    <div class="auth-container">
      <div class="auth-box">
        <div class="auth-header">
          <h1>ğŸ½ï¸ Meal Planner</h1>
          <p>Quáº£n lÃ½ thá»±c Ä‘Æ¡n thÃ´ng minh vá»›i AI</p>
        </div>

        <!-- TAB SWITCHER -->
        <div class="auth-tabs">
          <button class="tab-btn active" data-tab="login">ÄÄƒng nháº­p</button>
          <button class="tab-btn" data-tab="register">ÄÄƒng kÃ½</button>
        </div>

        <!-- LOGIN FORM -->
        <div id="login-form" class="auth-form active">
          <form onsubmit="handleLogin(event)">
            <div class="form-group">
              <label>ğŸ“§ Email</label>
              <input
                type="email"
                id="login-email"
                placeholder="your@email.com"
                required
              />
            </div>
            <div class="form-group">
              <label>ğŸ”’ Máº­t kháº©u</label>
              <input
                type="password"
                id="login-password"
                placeholder="Nháº­p máº­t kháº©u"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary btn-block">
              ÄÄƒng nháº­p
            </button>
          </form>
        </div>

        <!-- REGISTER FORM -->
        <div id="register-form" class="auth-form">
          <form onsubmit="handleRegister(event)">
            <div class="form-row">
              <div class="form-group">
                <label>ğŸ“§ Email</label>
                <input
                  type="email"
                  id="reg-email"
                  placeholder="your@email.com"
                  required
                />
              </div>
              <div class="form-group">
                <label>ğŸ‘¤ Há» tÃªn</label>
                <input
                  type="text"
                  id="reg-name"
                  placeholder="Nguyá»…n VÄƒn A"
                  required
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>ğŸ”’ Máº­t kháº©u</label>
                <input
                  type="password"
                  id="reg-password"
                  placeholder="Tá»‘i thiá»ƒu 6 kÃ½ tá»±"
                  required
                  minlength="6"
                  maxlength="50"
                />
                <small class="form-hint">Ãt nháº¥t 6 kÃ½ tá»±</small>
              </div>
              <div class="form-group">
                <label>âš§ Giá»›i tÃ­nh</label>
                <select id="reg-gender">
                  <option value="male">Nam</option>
                  <option value="female">Ná»¯</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>ğŸ“… NgÃ y sinh</label>
                <input type="date" id="reg-dob" required />
              </div>
              <div class="form-group">
                <label>ğŸ“ Chiá»u cao (cm)</label>
                <input
                  type="number"
                  id="reg-height"
                  placeholder="170"
                  min="100"
                  max="250"
                  step="0.1"
                />
                <small class="form-hint">Tá»« 100-250 cm</small>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>âš–ï¸ CÃ¢n náº·ng (kg)</label>
                <input
                  type="number"
                  id="reg-weight"
                  placeholder="65"
                  min="20"
                  max="300"
                  step="0.1"
                />
                <small class="form-hint">Tá»« 20-300 kg</small>
              </div>
              <div class="form-group">
                <label>ğŸ¥— Cháº¿ Ä‘á»™ Äƒn</label>
                <select id="reg-diet">
                  <option value="">KhÃ´ng háº¡n cháº¿</option>
                  <option value="vegetarian">Ä‚n chay</option>
                  <option value="vegan">Thuáº§n chay</option>
                  <option value="gluten_free">KhÃ´ng gluten</option>
                </select>
              </div>
            </div>

            <button type="submit" class="btn btn-primary btn-block">
              ÄÄƒng kÃ½
            </button>
          </form>
        </div>

        <div id="message" class="message"></div>
      </div>
    </div>

    <script src="js/config.js?v=4"></script>
    <script src="js/api.js?v=4"></script>
    <script src="js/utils.js?v=4"></script>
    <script>
      // Tab switching
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;

          document
            .querySelectorAll(".tab-btn")
            .forEach((b) => b.classList.remove("active"));
          document
            .querySelectorAll(".auth-form")
            .forEach((f) => f.classList.remove("active"));

          btn.classList.add("active");
          document.getElementById(tab + "-form").classList.add("active");
        });
      });

      // Handle Login
      async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;

        if (!email || !password) {
          showMessage("Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ email vÃ  máº­t kháº©u!", "error");
          return;
        }

        try {
          showMessage("Äang Ä‘Äƒng nháº­p...", "info");
          const response = await apiLogin(email, password);

          // LÆ°u token vÃ  táº¡o session ID má»›i
          localStorage.setItem("token", response.access_token);
          localStorage.setItem("user_email", email);
          localStorage.setItem(
            "session_id",
            Date.now().toString() + Math.random().toString(36)
          );

          showMessage(
            "âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng! Äang chuyá»ƒn trang...",
            "success"
          );
          setTimeout(() => {
            window.location.href = "dashboard.html";
          }, 1000);
        } catch (error) {
          console.error("Login error:", error);

          // Hiá»ƒn thá»‹ lá»—i cá»¥ thá»ƒ
          let errorMsg = "ÄÄƒng nháº­p tháº¥t báº¡i!";
          if (
            error.message.includes("401") ||
            error.message.includes("khÃ´ng chÃ­nh xÃ¡c")
          ) {
            errorMsg = "âŒ Email hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng! Vui lÃ²ng thá»­ láº¡i.";
          } else if (
            error.message.includes("network") ||
            error.message.includes("fetch")
          ) {
            errorMsg =
              "âš ï¸ KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c server. Vui lÃ²ng kiá»ƒm tra backend Ä‘ang cháº¡y!";
          } else {
            errorMsg = "âŒ " + (error.message || "Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh");
          }

          showMessage(errorMsg, "error");
        }
      }

      // Handle Register
      async function handleRegister(e) {
        e.preventDefault();

        const email = document.getElementById("reg-email").value;
        const password = document.getElementById("reg-password").value;
        const fullName = document.getElementById("reg-name").value;
        const dob = document.getElementById("reg-dob").value;
        const height = parseFloat(document.getElementById("reg-height").value);
        const weight = parseFloat(document.getElementById("reg-weight").value);

        // ============ VALIDATION ============

        // 1. Kiá»ƒm tra email
        if (!email || !password || !fullName) {
          showMessage("âŒ Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin báº¯t buá»™c!", "error");
          return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showMessage("âŒ Email khÃ´ng há»£p lá»‡!", "error");
          return;
        }

        // 2. Kiá»ƒm tra máº­t kháº©u
        if (password.length < 6) {
          showMessage("âŒ Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±!", "error");
          return;
        }

        if (password.length > 50) {
          showMessage("âŒ Máº­t kháº©u khÃ´ng Ä‘Æ°á»£c quÃ¡ 50 kÃ½ tá»±!", "error");
          return;
        }

        // 3. Kiá»ƒm tra há» tÃªn
        if (fullName.length < 2) {
          showMessage("âŒ Há» tÃªn pháº£i cÃ³ Ã­t nháº¥t 2 kÃ½ tá»±!", "error");
          return;
        }

        // 4. Kiá»ƒm tra ngÃ y sinh (tuá»•i tá»« 13-120)
        if (dob) {
          const birthDate = new Date(dob);
          const today = new Date();
          let age = today.getFullYear() - birthDate.getFullYear();
          const monthDiff = today.getMonth() - birthDate.getMonth();

          if (
            monthDiff < 0 ||
            (monthDiff === 0 && today.getDate() < birthDate.getDate())
          ) {
            age--;
          }

          if (age < 13) {
            showMessage("âŒ Báº¡n pháº£i Ã­t nháº¥t 13 tuá»•i Ä‘á»ƒ Ä‘Äƒng kÃ½!", "error");
            return;
          }

          if (age > 120) {
            showMessage(
              "âŒ NgÃ y sinh khÃ´ng há»£p lá»‡! Vui lÃ²ng kiá»ƒm tra láº¡i.",
              "error"
            );
            return;
          }
        }

        // 5. Kiá»ƒm tra chiá»u cao (100-250 cm)
        if (height && (height < 100 || height > 250)) {
          showMessage("âŒ Chiá»u cao pháº£i tá»« 100-250 cm!", "error");
          return;
        }

        // 6. Kiá»ƒm tra cÃ¢n náº·ng (20-300 kg)
        if (weight && (weight < 20 || weight > 300)) {
          showMessage("âŒ CÃ¢n náº·ng pháº£i tá»« 20-300 kg!", "error");
          return;
        }

        // ============ Táº O Dá»® LIá»†U ============

        const userData = {
          email: email,
          full_name: fullName,
          password: password,
          gender: document.getElementById("reg-gender").value,
          date_of_birth: dob || null,
          height: height || null,
          weight: weight || null,
          dietary_preferences:
            document.getElementById("reg-diet").value || null,
        };

        try {
          showMessage("Äang táº¡o tÃ i khoáº£n...", "info");
          await apiRegister(userData);

          showMessage("âœ… ÄÄƒng kÃ½ thÃ nh cÃ´ng! Vui lÃ²ng Ä‘Äƒng nháº­p.", "success");

          // Chuyá»ƒn sang tab login vÃ  Ä‘iá»n sáºµn email
          setTimeout(() => {
            document.querySelector('[data-tab="login"]').click();
            document.getElementById("login-email").value = userData.email;
            document.getElementById("login-password").focus();
          }, 1500);
        } catch (error) {
          console.error("Register error:", error);

          // Hiá»ƒn thá»‹ lá»—i cá»¥ thá»ƒ
          let errorMsg = "ÄÄƒng kÃ½ tháº¥t báº¡i!";
          if (
            error.message.includes("Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng") ||
            error.message.includes("already")
          ) {
            errorMsg =
              "âŒ Email nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½! Vui lÃ²ng Ä‘Äƒng nháº­p hoáº·c dÃ¹ng email khÃ¡c.";
          } else if (
            error.message.includes("network") ||
            error.message.includes("fetch")
          ) {
            errorMsg =
              "âš ï¸ KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c server. Vui lÃ²ng kiá»ƒm tra backend Ä‘ang cháº¡y!";
          } else {
            errorMsg = "âŒ " + (error.message || "Lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh");
          }

          showMessage(errorMsg, "error");
        }
      }

      function showMessage(text, type = "info") {
        const msg = document.getElementById("message");
        msg.textContent = text;
        msg.className = "message " + type;
        msg.style.display = "block";
      }

      // Kiá»ƒm tra náº¿u Ä‘ang logout thÃ¬ clear háº¿t localStorage
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has("logout")) {
        localStorage.clear();
        sessionStorage.clear();
        // Remove query string Ä‘á»ƒ URL sáº¡ch hÆ¡n
        window.history.replaceState(
          {},
          document.title,
          window.location.pathname
        );
      }

      // Check if already logged in
      if (localStorage.getItem("token")) {
        window.location.href = "dashboard.html";
      }
    </script>
  </body>
</html>
