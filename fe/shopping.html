<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping List - Meal Planner</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üçΩÔ∏è Meal Planner</h2>
                <div class="user-info">
                    <p><strong id="user-email">user@example.com</strong></p>
                </div>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="dashboard.html"><span>üè†</span> Dashboard</a></li>
                    <li><a href="recipes.html"><span>üìñ</span> C√¥ng th·ª©c</a></li>
                    <li><a href="planner.html"><span>üìÖ</span> L·ªãch ƒÉn</a></li>
                    <li><a href="shopping.html" class="active"><span>üõí</span> Shopping List</a></li>
                    <li><a href="ai-generator.html"><span>‚ú®</span> AI Generator</a></li>
                    <li><a href="#" onclick="logout()"><span>üö™</span> ƒêƒÉng xu·∫•t</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <div class="page-header">
                    <h1>üõí Danh s√°ch mua s·∫Øm</h1>
                    <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è In danh s√°ch</button>
                </div>

                <!-- Date Range Selector -->
                <div class="date-selector">
                    <div class="form-row">
                        <div class="form-group">
                            <label>T·ª´ ng√†y:</label>
                            <input type="date" id="start-date">
                        </div>
                        <div class="form-group">
                            <label>ƒê·∫øn ng√†y:</label>
                            <input type="date" id="end-date">
                        </div>
                        <button class="btn btn-primary" onclick="loadShoppingList()">T·∫°o danh s√°ch</button>
                    </div>
                    <div class="quick-dates">
                        <button class="btn btn-secondary" onclick="setThisWeek()">Tu·∫ßn n√†y</button>
                        <button class="btn btn-secondary" onclick="setNextWeek()">Tu·∫ßn sau</button>
                    </div>
                </div>

                <!-- Shopping List -->
                <div id="shopping-content" class="shopping-content">
                    <div class="empty-state">
                        <p>üìÖ Ch·ªçn kho·∫£ng th·ªùi gian ƒë·ªÉ t·∫°o danh s√°ch mua s·∫Øm</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script>
        checkAuth();
        
        // Load user info
        async function loadUserInfo() {
            try {
                const userInfo = await apiGetCurrentUser();
                document.getElementById('user-email').textContent = userInfo.email;
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }
        loadUserInfo();

        // Set default dates to current week
        window.onload = function() {
            setThisWeek();
        };

        function setThisWeek() {
            const week = getCurrentWeek();
            document.getElementById('start-date').value = week.start;
            document.getElementById('end-date').value = week.end;
            loadShoppingList();
        }

        function setNextWeek() {
            const today = new Date();
            const nextMonday = new Date(today);
            const dayOfWeek = today.getDay();
            const daysToAdd = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;
            nextMonday.setDate(today.getDate() + daysToAdd);
            
            const nextSunday = new Date(nextMonday);
            nextSunday.setDate(nextMonday.getDate() + 6);
            
            document.getElementById('start-date').value = nextMonday.toISOString().split('T')[0];
            document.getElementById('end-date').value = nextSunday.toISOString().split('T')[0];
            loadShoppingList();
        }

        async function loadShoppingList() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                showToast('Vui l√≤ng ch·ªçn kho·∫£ng th·ªùi gian', 'error');
                return;
            }

            try {
                showLoading();
                const data = await apiGetShoppingList(startDate, endDate);
                console.log('Shopping list data:', data); // Debug
                displayShoppingList(data);
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error loading shopping list:', error);
                showToast('L·ªói t·∫£i danh s√°ch: ' + error.message, 'error');
                // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói trong container
                const container = document.getElementById('shopping-content');
                container.innerHTML = `
                    <div class="empty-state">
                        <p>‚ùå L·ªói: ${error.message}</p>
                        <p>Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra k·∫øt n·ªëi server</p>
                    </div>
                `;
            }
        }

        function displayShoppingList(data) {
            const container = document.getElementById('shopping-content');
            
            // Ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá
            if (!data) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ server</p>
                        <p>Vui l√≤ng th·ª≠ l·∫°i</p>
                    </div>
                `;
                return;
            }

            // X·ª≠ l√Ω ingredients - API c√≥ th·ªÉ tr·∫£ v·ªÅ 'items' ho·∫∑c 'ingredients'
            const ingredients = data.items || data.ingredients || [];
            const recipes = data.recipes || [];
            
            // Ki·ªÉm tra n·∫øu c√≥ message t·ª´ server
            if (data.message && ingredients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>üìÖ ${data.message}</p>
                        <p>H√£y th√™m b·ªØa ƒÉn v√†o l·ªãch tr∆∞·ªõc!</p>
                        <p style="margin-top: 20px;">
                            <a href="planner.html" class="btn btn-primary" style="display: inline-block; padding: 10px 20px; text-decoration: none;">
                                ‚ûï Th√™m b·ªØa ƒÉn v√†o l·ªãch
                            </a>
                        </p>
                    </div>
                `;
                return;
            }
            
            if (!Array.isArray(ingredients)) {
                console.warn('Ingredients is not an array:', ingredients);
                container.innerHTML = `
                    <div class="empty-state">
                        <p>‚ùå D·ªØ li·ªáu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng</p>
                        <p>Vui l√≤ng th·ª≠ l·∫°i</p>
                    </div>
                `;
                return;
            }

            if (ingredients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>üìÖ Kh√¥ng c√≥ nguy√™n li·ªáu n√†o trong kho·∫£ng th·ªùi gian n√†y</p>
                        <p>H√£y th√™m b·ªØa ƒÉn v√†o l·ªãch tr∆∞·ªõc!</p>
                        <p style="margin-top: 20px;">
                            <a href="planner.html" class="btn btn-primary" style="display: inline-block; padding: 10px 20px; text-decoration: none;">
                                ‚ûï Th√™m b·ªØa ƒÉn v√†o l·ªãch
                            </a>
                        </p>
                    </div>
                `;
                return;
            }

            // T·∫°o danh s√°ch nguy√™n li·ªáu v·ªõi x·ª≠ l√Ω l·ªói
            const ingredientsList = ingredients.map((ing, index) => {
                // X·ª≠ l√Ω c√°c format kh√°c nhau c·ªßa ingredient
                const name = ing.name || ing.ingredient_name || `Nguy√™n li·ªáu ${index + 1}`;
                const amount = ing.total_amount || ing.amount || ing.quantity || 0;
                const unit = ing.unit || 'ph·∫ßn';
                // T·∫°o ID an to√†n (lo·∫°i b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát)
                const safeId = `ing-${index}-${name.replace(/[^a-zA-Z0-9]/g, '-')}`;
                
                return `
                    <div class="ingredient-item">
                        <input type="checkbox" id="${safeId}" onchange="toggleIngredient(this)">
                        <label for="${safeId}">
                            <span class="ing-name">${name}</span>
                            <span class="ing-amount">${amount} ${unit}</span>
                        </label>
                    </div>
                `;
            }).join('');

            // T·∫°o danh s√°ch m√≥n ƒÉn v·ªõi x·ª≠ l√Ω l·ªói
            const recipesList = Array.isArray(recipes) 
                ? recipes.map(recipe => {
                    // X·ª≠ l√Ω c·∫£ string v√† object
                    const recipeName = typeof recipe === 'string' ? recipe : (recipe.name || 'M√≥n ƒÉn');
                    return `<div class="recipe-tag">${recipeName}</div>`;
                }).join('')
                : '';

            container.innerHTML = `
                <div class="shopping-summary">
                    <h3>üìä T·ªïng quan</h3>
                    <p><strong>${ingredients.length}</strong> nguy√™n li·ªáu c·∫ßn mua</p>
                    <p><strong>${recipes.length || 0}</strong> m√≥n ƒÉn</p>
                </div>

                <div class="shopping-section">
                    <h3>üõí Danh s√°ch nguy√™n li·ªáu</h3>
                    <div class="ingredients-checklist">
                        ${ingredientsList}
                    </div>
                </div>

                ${recipesList ? `
                <div class="shopping-section">
                    <h3>üìñ C√°c m√≥n ƒÉn</h3>
                    <div class="recipes-tags">
                        ${recipesList}
                    </div>
                </div>
                ` : ''}
            `;
        }

        function toggleIngredient(checkbox) {
            const label = checkbox.nextElementSibling;
            if (checkbox.checked) {
                label.style.textDecoration = 'line-through';
                label.style.opacity = '0.5';
            } else {
                label.style.textDecoration = 'none';
                label.style.opacity = '1';
            }
        }
    </script>

    <style>
        .date-selector {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .quick-dates {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .shopping-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 400px;
        }

        .shopping-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .shopping-summary h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .shopping-section {
            margin: 30px 0;
        }

        .shopping-section h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .ingredients-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .ingredient-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .ingredient-item:hover {
            background: #e9ecef;
        }

        .ingredient-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            cursor: pointer;
        }

        .ingredient-item label {
            flex: 1;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ing-name {
            font-weight: 600;
            color: #333;
        }

        .ing-amount {
            color: #667eea;
            font-weight: 600;
        }

        .recipes-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .recipe-tag {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state p {
            font-size: 1.1em;
            margin: 10px 0;
        }

        /* Print styles */
        @media print {
            .main-layout {
                display: block;
            }

            .sidebar, .page-header button, .date-selector {
                display: none !important;
            }

            .shopping-content {
                box-shadow: none;
            }

            .ingredient-item {
                break-inside: avoid;
            }
        }
    </style>
</body>
</html>
