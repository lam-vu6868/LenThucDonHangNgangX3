<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Generator - Meal Planner</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üçΩÔ∏è Meal Planner</h2>
                <div class="user-info">
                    <p><strong id="user-email">user@example.com</strong></p>
                </div>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="dashboard.html"><span>üè†</span> Dashboard</a></li>
                    <li><a href="recipes.html"><span>üìñ</span> C√¥ng th·ª©c</a></li>
                    <li><a href="planner.html"><span>üìÖ</span> L·ªãch ƒÉn</a></li>
                    <li><a href="shopping.html"><span>üõí</span> Shopping List</a></li>
                    <li><a href="ai-generator.html" class="active"><span>‚ú®</span> AI Generator</a></li>
                    <li><a href="#" onclick="logout()"><span>üö™</span> ƒêƒÉng xu·∫•t</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <h1>‚ú® AI G·ª£i √Ω m√≥n ƒÉn</h1>

                <!-- Tab Navigation -->
                <div class="ai-tabs">
                    <button class="tab-btn active" onclick="switchTab('generate')">T·∫°o m√≥n t·ª´ nguy√™n li·ªáu</button>
                    <button class="tab-btn" onclick="switchTab('weekly')">L√™n k·∫ø ho·∫°ch tu·∫ßn</button>
                    <button class="tab-btn" onclick="switchTab('search')">T√¨m ki·∫øm th√¥ng minh</button>
                </div>

                <!-- Generate Recipe Tab -->
                <div id="generate-tab" class="ai-tab-content active">
                    <div class="ai-card">
                        <h2>ü•ò T·∫°o m√≥n ƒÉn t·ª´ nguy√™n li·ªáu c√≥ s·∫µn</h2>
                        <p>Nh·∫≠p c√°c nguy√™n li·ªáu b·∫°n c√≥, AI s·∫Ω g·ª£i √Ω c√¥ng th·ª©c ph√π h·ª£p</p>
                        
                        <div class="form-group">
                            <label>Nguy√™n li·ªáu (c√°ch nhau b·∫±ng d·∫•u ph·∫©y):</label>
                            <textarea id="ingredients-input" rows="3" placeholder="VD: g√†, c√† chua, h√†nh, t·ªèi, ·ªõt"></textarea>
                        </div>
                        
                        <button class="btn btn-primary btn-block" onclick="generateRecipe()">
                            ‚ú® T·∫°o c√¥ng th·ª©c
                        </button>
                        
                        <div id="generate-result" class="ai-result"></div>
                    </div>
                </div>

                <!-- Weekly Plan Tab -->
                <div id="weekly-tab" class="ai-tab-content">
                    <div class="ai-card">
                        <h2>üìÖ L√™n k·∫ø ho·∫°ch ƒÉn u·ªëng c·∫£ tu·∫ßn</h2>
                        <p>AI s·∫Ω t·∫°o th·ª±c ƒë∆°n c√¢n b·∫±ng dinh d∆∞·ª°ng cho 7 ng√†y</p>
                        
                        <div class="form-group">
                            <label>M·ª©c ƒë·ªô ho·∫°t ƒë·ªông:</label>
                            <select id="activity-level">
                                <option value="sedentary">√çt v·∫≠n ƒë·ªông (vƒÉn ph√≤ng)</option>
                                <option value="light">V·∫≠n ƒë·ªông nh·∫π (1-3 ng√†y/tu·∫ßn)</option>
                                <option value="moderate" selected>V·∫≠n ƒë·ªông v·ª´a (3-5 ng√†y/tu·∫ßn)</option>
                                <option value="active">V·∫≠n ƒë·ªông nhi·ªÅu (6-7 ng√†y/tu·∫ßn)</option>
                                <option value="very_active">V·∫≠n ƒë·ªông c·ª±c nhi·ªÅu (v·∫≠n ƒë·ªông vi√™n)</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-primary btn-block" onclick="generateWeeklyPlan()">
                            ‚ú® T·∫°o k·∫ø ho·∫°ch tu·∫ßn
                        </button>
                        
                        <div id="weekly-result" class="ai-result"></div>
                    </div>
                </div>

                <!-- Search Tab -->
                <div id="search-tab" class="ai-tab-content">
                    <div class="ai-card">
                        <h2>üîç T√¨m ki·∫øm th√¥ng minh</h2>
                        <p>M√¥ t·∫£ m√≥n ƒÉn b·∫°n mu·ªën, AI s·∫Ω t√¨m c√¥ng th·ª©c ph√π h·ª£p</p>
                        
                        <div class="form-group">
                            <label>M√¥ t·∫£ m√≥n ƒÉn:</label>
                            <textarea id="search-query" rows="3" placeholder="VD: M√≥n Vi·ªát Nam, √≠t cay, gi√†u protein, n·∫•u nhanh"></textarea>
                        </div>
                        
                        <button class="btn btn-primary btn-block" onclick="searchRecipes()">
                            üîç T√¨m ki·∫øm
                        </button>
                        
                        <div id="search-result" class="ai-result"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script>
        checkAuth();
        
        // Load user info
        async function loadUserInfo() {
            try {
                const userInfo = await apiGetCurrentUser();
                document.getElementById('user-email').textContent = userInfo.email;
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }
        loadUserInfo();

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.ai-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        async function generateRecipe() {
            const ingredients = document.getElementById('ingredients-input').value.trim();
            
            if (!ingredients) {
                showToast('Vui l√≤ng nh·∫≠p nguy√™n li·ªáu', 'error');
                return;
            }

            const resultDiv = document.getElementById('generate-result');
            resultDiv.innerHTML = '<div class="loading">AI ƒëang t·∫°o c√¥ng th·ª©c... ‚è≥</div>';

            try {
                showLoading();
                const ingredientsList = ingredients.split(',').map(i => i.trim());
                const response = await apiGenerateRecipe(ingredientsList);
                hideLoading();
                
                // X·ª≠ l√Ω response - c√≥ th·ªÉ l√† recipe tr·ª±c ti·∫øp ho·∫∑c c√≥ wrapper
                const recipe = response.recipe || response;
                
                // Ki·ªÉm tra v√† x·ª≠ l√Ω ingredients
                const ingredientsList_html = (recipe.ingredients && Array.isArray(recipe.ingredients) && recipe.ingredients.length > 0)
                    ? recipe.ingredients.map(ing => {
                        const name = ing.name || ing.ingredient || 'Nguy√™n li·ªáu';
                        const amount = ing.amount || ing.quantity || ing.amount || 1;
                        const unit = ing.unit || 'ph·∫ßn';
                        return `<li>${name}: ${amount} ${unit}</li>`;
                    }).join('')
                    : '<li>Kh√¥ng c√≥ th√¥ng tin nguy√™n li·ªáu</li>';
                
                // X·ª≠ l√Ω c√°c tr∆∞·ªùng c√≥ th·ªÉ thi·∫øu
                const recipeName = recipe.name || 'C√¥ng th·ª©c m·ªõi';
                const category = recipe.category || recipe.tags || 'Lunch';
                const cookingTime = recipe.cooking_time || recipe.prep_time || 30;
                const calories = recipe.calories || 0;
                const protein = recipe.protein || 0;
                const carbs = recipe.carbs || 0;
                const fat = recipe.fat || 0;
                const instructions = recipe.instructions || 'Ch∆∞a c√≥ h∆∞·ªõng d·∫´n';
                const recipeId = recipe.id || null;
                
                resultDiv.innerHTML = `
                    <div class="success-message">
                        <h3>‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng!</h3>
                        <div class="recipe-result">
                            <h4>${recipeName}</h4>
                            <p><strong>Lo·∫°i:</strong> ${category}</p>
                            <p><strong>Th·ªùi gian:</strong> ${cookingTime} ph√∫t</p>
                            
                            <div class="nutrition-summary">
                                <span>üî• ${Math.round(calories)} kcal</span>
                                <span>ü•© ${protein}g protein</span>
                                <span>üçö ${carbs}g carbs</span>
                                <span>üßà ${fat}g fat</span>
                            </div>
                            
                            <h5>Nguy√™n li·ªáu:</h5>
                            <ul>
                                ${ingredientsList_html}
                            </ul>
                            
                            <h5>H∆∞·ªõng d·∫´n:</h5>
                            <p style="white-space: pre-line;">${instructions}</p>
                            
                            ${recipeId ? `<button class="btn btn-primary" onclick="saveGeneratedRecipe(${recipeId})">
                                üíæ L∆∞u v√†o danh s√°ch
                            </button>` : '<p style="color: #666; font-style: italic;">C√¥ng th·ª©c n√†y ch∆∞a c√≥ ID, kh√¥ng th·ªÉ l∆∞u tr·ª±c ti·∫øp</p>'}
                        </div>
                    </div>
                `;
                
                showToast('ƒê√£ t·∫°o c√¥ng th·ª©c th√†nh c√¥ng!', 'success');
            } catch (error) {
                hideLoading();
                resultDiv.innerHTML = `
                    <div class="error-message">
                        <p>‚ùå L·ªói: ${error.message}</p>
                        <p>Vui l√≤ng th·ª≠ l·∫°i v·ªõi nguy√™n li·ªáu kh√°c</p>
                    </div>
                `;
                showToast('L·ªói t·∫°o c√¥ng th·ª©c: ' + error.message, 'error');
            }
        }

        async function generateWeeklyPlan() {
            const activityLevel = document.getElementById('activity-level').value;
            const resultDiv = document.getElementById('weekly-result');
            
            resultDiv.innerHTML = '<div class="loading">AI ƒëang l√™n k·∫ø ho·∫°ch... ‚è≥</div>';

            try {
                showLoading();
                const response = await apiSuggestWeeklyPlan(activityLevel);
                hideLoading();
                
                // X·ª≠ l√Ω response - c√≥ th·ªÉ l√† plan tr·ª±c ti·∫øp ho·∫∑c c√≥ wrapper
                const plan = response.plan || response.weekly_plan || response;
                
                // Ki·ªÉm tra plan c√≥ ph·∫£i l√† array kh√¥ng
                if (!Array.isArray(plan)) {
                    throw new Error('K·∫ø ho·∫°ch tu·∫ßn kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng');
                }
                
                const days = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'Ch·ªß nh·∫≠t'];
                
                resultDiv.innerHTML = `
                    <div class="success-message">
                        <h3>‚úÖ K·∫ø ho·∫°ch tu·∫ßn ƒë√£ s·∫µn s√†ng!</h3>
                        <div class="weekly-plan">
                            ${plan.map((day, index) => {
                                const breakfast = day.breakfast || day.morning || 'Ch∆∞a c√≥';
                                const lunch = day.lunch || day.noon || 'Ch∆∞a c√≥';
                                const dinner = day.dinner || day.evening || 'Ch∆∞a c√≥';
                                return `
                                <div class="day-plan">
                                    <h4>${days[index] || `Ng√†y ${index + 1}`}</h4>
                                    <div class="meals">
                                        <div class="meal"><strong>S√°ng:</strong> ${breakfast}</div>
                                        <div class="meal"><strong>Tr∆∞a:</strong> ${lunch}</div>
                                        <div class="meal"><strong>T·ªëi:</strong> ${dinner}</div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                showToast('ƒê√£ t·∫°o k·∫ø ho·∫°ch tu·∫ßn!', 'success');
            } catch (error) {
                hideLoading();
                resultDiv.innerHTML = `
                    <div class="error-message">
                        <p>‚ùå L·ªói: ${error.message}</p>
                    </div>
                `;
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        async function searchRecipes() {
            const query = document.getElementById('search-query').value.trim();
            
            if (!query) {
                showToast('Vui l√≤ng nh·∫≠p m√¥ t·∫£', 'error');
                return;
            }

            const resultDiv = document.getElementById('search-result');
            resultDiv.innerHTML = '<div class="loading">AI ƒëang t√¨m ki·∫øm... ‚è≥</div>';

            try {
                showLoading();
                const response = await apiSearchRecipes(query);
                hideLoading();
                
                // X·ª≠ l√Ω response - c√≥ th·ªÉ l√† results tr·ª±c ti·∫øp ho·∫∑c c√≥ wrapper
                const results = response.results || response.suggestions || response;
                
                // Ki·ªÉm tra results c√≥ ph·∫£i l√† array kh√¥ng
                if (!Array.isArray(results)) {
                    throw new Error('K·∫øt qu·∫£ t√¨m ki·∫øm kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng');
                }
                
                if (results.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="info-message">
                            <p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p</p>
                            <p>Th·ª≠ m√¥ t·∫£ chi ti·∫øt h∆°n ho·∫∑c thay ƒë·ªïi t·ª´ kh√≥a</p>
                        </div>
                    `;
                    return;
                }
                
                resultDiv.innerHTML = `
                    <div class="success-message">
                        <h3>‚úÖ T√¨m th·∫•y ${results.length} k·∫øt qu·∫£</h3>
                        <div class="search-results">
                            ${results.map(recipe => {
                                const name = recipe.name || 'C√¥ng th·ª©c';
                                const description = recipe.description || '';
                                const cookingTime = recipe.cooking_time || recipe.prep_time || 0;
                                const calories = recipe.calories || 0;
                                const category = recipe.category || recipe.tags || 'Lunch';
                                return `
                                <div class="search-result-item">
                                    <h4>${name}</h4>
                                    <p>${description}</p>
                                    <div class="result-meta">
                                        <span>‚è±Ô∏è ${cookingTime} ph√∫t</span>
                                        <span>üî• ${Math.round(calories)} kcal</span>
                                        <span>${category}</span>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                
                showToast(`T√¨m th·∫•y ${results.length} c√¥ng th·ª©c!`, 'success');
            } catch (error) {
                hideLoading();
                resultDiv.innerHTML = `
                    <div class="error-message">
                        <p>‚ùå L·ªói: ${error.message}</p>
                    </div>
                `;
                showToast('L·ªói t√¨m ki·∫øm: ' + error.message, 'error');
            }
        }

        async function saveGeneratedRecipe(recipeId) {
            showToast('C√¥ng th·ª©c ƒë√£ ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông!', 'success');
            setTimeout(() => {
                window.location.href = 'recipes.html';
            }, 1500);
        }
    </script>

    <style>
        .ai-tabs {
            display: flex;
            gap: 10px;
            margin: 30px 0;
            border-bottom: 2px solid #eee;
        }

        .ai-tabs .tab-btn {
            padding: 15px 25px;
            border: none;
            background: none;
            color: #666;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .ai-tabs .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .ai-tab-content {
            display: none;
        }

        .ai-tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .ai-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .ai-card h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .ai-card > p {
            color: #666;
            margin-bottom: 30px;
        }

        .ai-result {
            margin-top: 30px;
        }

        .success-message {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            border-radius: 10px;
            padding: 20px;
        }

        .success-message h3 {
            color: #155724;
            margin-bottom: 20px;
        }

        .error-message {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            border-radius: 10px;
            padding: 20px;
            color: #721c24;
        }

        .info-message {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 10px;
            padding: 20px;
            color: #0c5460;
        }

        .recipe-result {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .recipe-result h4 {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .nutrition-summary {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .nutrition-summary span {
            font-weight: 600;
            color: #333;
        }

        .recipe-result ul {
            background: #f8f9fa;
            padding: 20px 20px 20px 40px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .recipe-result li {
            margin: 8px 0;
        }

        .weekly-plan {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .day-plan {
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        .day-plan h4 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .meals .meal {
            padding: 10px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .search-results {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .search-result-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .search-result-item h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .result-meta {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</body>
</html>
