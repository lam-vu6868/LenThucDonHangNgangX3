<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard - Meal Planner</title>
    <link rel="stylesheet" href="css/style.css?v=1">
</head>
<body>
    <div class="main-layout">
        <!-- Sidebar will be loaded by sidebar.js -->

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <h1>Xin ch√†o! üëã</h1>
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìñ</div>
                        <div class="stat-info">
                            <h3 id="recipe-count">0</h3>
                            <p>C√¥ng th·ª©c</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-info">
                            <h3 id="plan-count">0</h3>
                            <p>B·ªØa ƒÉn tu·∫ßn n√†y</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üî•</div>
                        <div class="stat-info">
                            <h3 id="bmr-value">0</h3>
                            <p>BMR (kcal/ng√†y)</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">üõí</div>
                        <div class="stat-info">
                            <h3 id="shopping-items">0</h3>
                            <p>Nguy√™n li·ªáu c·∫ßn mua</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="section">
                    <h2>Thao t√°c nhanh</h2>
                    <div class="quick-actions">
                        <a href="#" onclick="showProfileModal(); return false;" class="action-btn">
                            <span>üë§</span>
                            <p>C·∫≠p nh·∫≠t th√¥ng tin</p>
                        </a>
                        <a href="recipes.html" class="action-btn">
                            <span>‚ûï</span>
                            <p>Th√™m c√¥ng th·ª©c</p>
                        </a>
                        <a href="planner.html" class="action-btn">
                            <span>üìÖ</span>
                            <p>L·∫≠p k·∫ø ho·∫°ch</p>
                        </a>
                        <a href="shopping.html" class="action-btn">
                            <span>üõí</span>
                            <p>shopping list</p>
                        </a>
                    </div>
                </div>

                <!-- Recent Meals -->
                <div class="section">
                    <h2>B·ªØa ƒÉn tu·∫ßn n√†y</h2>
                    <div id="recent-meals" class="meals-list">
                        <p class="empty-state">Ch∆∞a c√≥ b·ªØa ƒÉn n√†o. H√£y th√™m v√†o l·ªãch!</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Profile Update Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n</h2>
                <button class="close-btn" onclick="closeProfileModal()">&times;</button>
            </div>
            
            <form id="profile-form" onsubmit="updateProfile(event)">
                <div class="form-group">
                    <label>T√™n ƒëƒÉng nh·∫≠p: *</label>
                    <input type="text" id="profile-full-name" class="form-control" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Chi·ªÅu cao (cm) *</label>
                        <input type="number" id="profile-height" step="0.1" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label>C√¢n n·∫∑ng (kg) *</label>
                        <input type="number" id="profile-weight" step="0.1" min="0" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Ng√†y sinh *</label>
                        <input type="date" id="profile-dob" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Gi·ªõi t√≠nh *</label>
                        <select id="profile-gender" required>
                            <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                            <option value="male">Nam</option>
                            <option value="female">N·ªØ</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ch·∫ø ƒë·ªô ƒÉn</label>
                    <select id="profile-diet">
                        <option value="">Kh√¥ng c√≥</option>
                        <option value="vegetarian">Chay</option>
                        <option value="vegan">Thu·∫ßn chay</option>
                        <option value="halal">Halal</option>
                        <option value="gluten_free">Kh√¥ng gluten</option>
                    </select>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeProfileModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/config.js?v=4"></script>
    <script src="js/api.js?v=4"></script>
    <script src="js/utils.js?v=4"></script>
    <script src="js/sidebar.js?v=4"></script>
    <script>
        // Check authentication
        if (!checkAuth()) {
            window.location.href = 'index.html';
        }
        setupPageReloadOnResume(); // T·ª± ƒë·ªông reload khi ƒë·ªïi user
        
        // Ki·ªÉm tra n·∫øu l√† admin th√¨ redirect v·ªÅ trang admin
        async function checkUserRole() {
            try {
                const user = await apiGetCurrentUser();
                if (user.role === 'admin') {
                    window.location.href = 'admin.html';
                    return;
                }
            } catch (error) {
                console.error('Error checking user role:', error);
            }
        }
        checkUserRole();
        
        // Render sidebar chung
        renderSidebar('dashboard').catch(console.error);

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Get current user info (sidebar.js ƒë√£ load user info v√†o sidebar, ch·ªâ c·∫ßn l·∫•y ƒë·ªÉ t√≠nh BMR)
                const userInfo = await apiGetCurrentUser();
                
                // Calculate BMR if height and weight exist
                if (userInfo.height && userInfo.weight && userInfo.gender && userInfo.date_of_birth) {
                    const age = new Date().getFullYear() - new Date(userInfo.date_of_birth).getFullYear();
                    let bmr = 0;
                    if (userInfo.gender === 'male') {
                        bmr = 88.362 + (13.397 * userInfo.weight) + (4.799 * userInfo.height) - (5.677 * age);
                    } else {
                        bmr = 447.593 + (9.247 * userInfo.weight) + (3.098 * userInfo.height) - (4.330 * age);
                    }
                    document.getElementById('bmr-value').textContent = Math.round(bmr);
                }

                // Get current week
                const week = getCurrentWeek();

                // Load stats
                const [recipes, plans, shoppingItems] = await Promise.all([
                    apiGetRecipes(),
                    apiGetMealPlans(week.start, week.end),
                    apiGetShoppingListItems().catch(() => []) // Load shopping list items t·ª´ database
                ]);

                // Update stats
                document.getElementById('recipe-count').textContent = recipes.length || 0;
                document.getElementById('plan-count').textContent = plans.length || 0;
                
                // ƒê·∫øm s·ªë nguy√™n li·ªáu ch∆∞a mua
                const unpurchasedItems = shoppingItems.filter(item => !item.is_purchased);
                document.getElementById('shopping-items').textContent = unpurchasedItems.length || 0;

                // Display recent meals
                displayRecentMeals(plans);

            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
            }
        }

        function displayRecentMeals(plans) {
            const container = document.getElementById('recent-meals');
            
            if (!plans || plans.length === 0) {
                container.innerHTML = '<p class="empty-state">Ch∆∞a c√≥ b·ªØa ƒÉn n√†o. H√£y th√™m v√†o l·ªãch!</p>';
                return;
            }

            container.innerHTML = plans.map(plan => `
                <div class="meal-item">
                    <div class="meal-date">${formatDate(plan.date)}</div>
                    <div class="meal-type">${plan.meal_type}</div>
                    <div class="meal-recipe">${plan.recipe.name}</div>
                    <div class="meal-servings">${plan.servings} ph·∫ßn</div>
                </div>
            `).join('');
        }

        // Load on page ready
        loadDashboard();
        
        // ƒê·∫£m b·∫£o modal ·∫©n khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('profile-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        });

        // Profile Modal Functions
        function showProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.style.display = 'flex';
            
            // Load current data if exists
            apiGetCurrentUser().then(user => {
                if (user.full_name) document.getElementById('profile-full-name').value = user.full_name;
                if (user.height) document.getElementById('profile-height').value = user.height;
                if (user.weight) document.getElementById('profile-weight').value = user.weight;
                if (user.date_of_birth) document.getElementById('profile-dob').value = user.date_of_birth;
                if (user.gender) document.getElementById('profile-gender').value = user.gender;
                if (user.dietary_preferences) document.getElementById('profile-diet').value = user.dietary_preferences;
            });
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
        }

        async function updateProfile(event) {
            event.preventDefault();
            
            try {
                const profileData = {
                    full_name: document.getElementById('profile-full-name').value.trim(),
                    height: parseFloat(document.getElementById('profile-height').value),
                    weight: parseFloat(document.getElementById('profile-weight').value),
                    date_of_birth: document.getElementById('profile-dob').value,
                    gender: document.getElementById('profile-gender').value,
                    dietary_preferences: document.getElementById('profile-diet').value || null
                };
                
                // Use apiCall helper function
                const updatedUser = await apiCall('/auth/me', {
                    method: 'PUT',
                    body: JSON.stringify(profileData)
                });
                
                showToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin!', 'success');
                closeProfileModal();
                loadDashboard();
                
            } catch (error) {
                showToast('L·ªói: ' + error.message, 'error');
            }
        }

        // Close modal when click outside
        window.onclick = function(event) {
            const modal = document.getElementById('profile-modal');
            if (event.target === modal) {
                closeProfileModal();
            }
        }
    </script>

    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .stat-icon {
            font-size: 3em;
        }

        .stat-info h3 {
            font-size: 2em;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-info p {
            color: #666;
            font-size: 0.9em;
        }

        .section {
            margin: 40px 0;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .action-btn {
            background: white;
            padding: 30px 20px;
            border-radius: 15px;
            text-align: center;
            text-decoration: none;
            color: #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .action-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .action-btn span {
            font-size: 2.5em;
            display: block;
            margin-bottom: 10px;
        }

        .action-btn p {
            font-weight: 600;
            color: #667eea;
        }

        .meals-list {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .meal-item {
            display: grid;
            grid-template-columns: 120px 100px 1fr 80px;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .meal-item:last-child {
            border-bottom: none;
        }

        .meal-date {
            color: #666;
            font-size: 0.9em;
        }

        .meal-type {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            text-align: center;
        }

        .meal-recipe {
            font-weight: 600;
            color: #333;
        }

        .meal-servings {
            color: #666;
            font-size: 0.9em;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px;
        }
    </style>
</body>
</html>
